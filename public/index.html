<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>De Lijn · Live Tracker</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet" />

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #080c10;
      --surface:   #0e1419;
      --surface2:  #141b23;
      --border:    #1e2d3d;
      --accent:    #00d4ff;
      --accent2:   #ff6b35;
      --accent3:   #a8ff3e;
      --muted:     #4a6070;
      --text:      #c8dae8;
      --text-dim:  #6b8899;
      --danger:    #ff3b5c;
      --font-ui:   'Oxanium', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    html, body { width:100%; height:100%; background:var(--bg); color:var(--text); font-family:var(--font-ui); overflow:hidden; }

    #app { position:relative; width:100vw; height:100vh; display:flex; }
    #map { flex:1; height:100%; background:var(--bg); z-index:1; }

    #sidebar {
      position:absolute; top:0; left:0; bottom:0; width:280px;
      background:linear-gradient(180deg,rgba(8,12,16,0.97) 0%,rgba(14,20,25,0.95) 100%);
      border-right:1px solid var(--border);
      display:flex; flex-direction:column; z-index:100;
      backdrop-filter:blur(12px);
    }

    #header { padding:20px 20px 16px; border-bottom:1px solid var(--border); flex-shrink:0; }
    .logo-row { display:flex; align-items:center; gap:10px; margin-bottom:4px; }
    .logo-icon {
      width:32px; height:32px; background:var(--accent);
      clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
      display:flex; align-items:center; justify-content:center; flex-shrink:0;
    }
    .logo-icon svg { width:18px; height:18px; fill:var(--bg); }
    .logo-text { font-size:18px; font-weight:700; letter-spacing:0.08em; color:#fff; }
    .logo-sub { font-size:10px; letter-spacing:0.2em; text-transform:uppercase; color:var(--accent); font-family:var(--font-mono); }

    #status-bar { padding:12px 20px; border-bottom:1px solid var(--border); flex-shrink:0; }
    .status-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
    .status-label { font-size:10px; letter-spacing:0.15em; text-transform:uppercase; color:var(--text-dim); font-family:var(--font-mono); }
    .status-value { font-size:13px; font-weight:600; font-family:var(--font-mono); color:var(--text); }

    .live-dot { display:inline-flex; align-items:center; gap:6px; font-size:10px; letter-spacing:0.1em; text-transform:uppercase; font-family:var(--font-mono); }
    .pulse { width:7px; height:7px; border-radius:50%; background:var(--accent3); animation:pulseAnim 2s infinite; }
    .pulse.error { background:var(--danger); }
    .pulse.loading { background:var(--accent); animation:spin 1s linear infinite; }
    @keyframes pulseAnim { 0%{box-shadow:0 0 0 0 rgba(168,255,62,0.6)} 70%{box-shadow:0 0 0 8px rgba(168,255,62,0)} 100%{box-shadow:0 0 0 0 rgba(168,255,62,0)} }
    @keyframes spin { to{transform:rotate(360deg)} }

    #refresh-bar { height:2px; background:var(--border); border-radius:1px; margin-top:8px; overflow:hidden; }
    #refresh-progress { height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:1px; transition:width 1s linear; }

    #stats { padding:14px 20px; border-bottom:1px solid var(--border); display:grid; grid-template-columns:1fr 1fr; gap:10px; flex-shrink:0; }
    .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:6px; padding:10px; }
    .stat-num { font-size:22px; font-weight:700; font-family:var(--font-mono); color:var(--accent); line-height:1; }
    .stat-num.orange{color:var(--accent2)} .stat-num.green{color:var(--accent3)} .stat-num.red{color:var(--danger)}
    .stat-label { font-size:9px; letter-spacing:0.15em; text-transform:uppercase; color:var(--text-dim); margin-top:4px; font-family:var(--font-mono); }

    #vehicle-list-header {
      padding:10px 20px 8px; font-size:10px; letter-spacing:0.15em; text-transform:uppercase;
      color:var(--text-dim); font-family:var(--font-mono); border-bottom:1px solid var(--border);
      flex-shrink:0; display:flex; justify-content:space-between; align-items:center;
    }

    /* Virtual scroll container */
    #vehicle-list { flex:1; overflow-y:auto; scrollbar-width:thin; scrollbar-color:var(--border) transparent; position:relative; }
    #vehicle-list::-webkit-scrollbar{width:4px}
    #vehicle-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
    #vlist-spacer { width:1px; } /* height set by JS to create scroll space */
    #vlist-window { position:absolute; top:0; left:0; right:0; } /* positioned by JS */

    .vehicle-item {
      padding:10px 20px; border-bottom:1px solid rgba(30,45,61,0.5);
      cursor:pointer; transition:background 0.15s; display:flex; align-items:center; gap:10px;
      height:52px; /* fixed height required for virtual scroll */
    }
    .vehicle-item:hover{background:rgba(0,212,255,0.04)}
    .vehicle-item.active{background:rgba(0,212,255,0.08);border-left:2px solid var(--accent);padding-left:18px}
    .v-badge { width:36px;height:22px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;font-family:var(--font-mono);flex-shrink:0; }
    .v-info{flex:1;min-width:0}
    .v-route{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .v-meta{font-size:10px;color:var(--text-dim);font-family:var(--font-mono);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .v-delay{font-size:11px;font-family:var(--font-mono);font-weight:500;flex-shrink:0}

    /* Popups */
    .leaflet-popup-content-wrapper{background:var(--surface)!important;border:1px solid var(--accent)!important;border-radius:8px!important;box-shadow:0 4px 32px rgba(0,212,255,0.2)!important;color:var(--text)!important;font-family:var(--font-ui)!important;padding:0!important}
    .leaflet-popup-tip{background:var(--accent)!important}
    .leaflet-popup-content{margin:0!important;line-height:1.4!important}
    .popup-inner{padding:14px 16px;min-width:200px}
    .popup-route{font-size:20px;font-weight:700;color:var(--accent);font-family:var(--font-ui);margin-bottom:2px}
    .popup-trip{font-size:10px;color:var(--text-dim);font-family:var(--font-mono);margin-bottom:10px;word-break:break-all}
    .popup-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .popup-field-label{font-size:9px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);font-family:var(--font-mono)}
    .popup-field-value{font-size:13px;font-weight:600;font-family:var(--font-mono);color:var(--text)}

    .leaflet-control-attribution{background:rgba(8,12,16,0.8)!important;color:var(--muted)!important;font-size:10px!important}
    .leaflet-control-attribution a{color:var(--accent)!important}
    .leaflet-control-zoom a{background:var(--surface)!important;border-color:var(--border)!important;color:var(--text)!important}
    .leaflet-control-zoom a:hover{background:var(--surface2)!important}

    #toast {
      position:fixed; bottom:24px; right:24px; background:var(--surface); border:1px solid var(--border);
      border-radius:6px; padding:12px 16px; font-size:12px; font-family:var(--font-mono);
      color:var(--text); z-index:9999; opacity:0; transform:translateY(8px);
      transition:opacity 0.2s,transform 0.2s; pointer-events:none; max-width:320px;
    }
    #toast.show{opacity:1;transform:translateY(0)}
    #toast.error{border-color:var(--danger);color:var(--danger)}

    #map-branding {
      position:absolute; bottom:32px; left:296px; z-index:50;
      font-family:var(--font-ui); font-size:11px; font-weight:300; letter-spacing:0.3em;
      text-transform:uppercase; color:rgba(200,218,232,0.25); pointer-events:none;
    }
  </style>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <div id="header">
      <div class="logo-row">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24"><path d="M4 16c0 1.1.9 2 2 2h1l1 2h8l1-2h1c1.1 0 2-.9 2-2V6c0-3.5-3.6-4-8-4S4 2.5 4 6zm8-11c3.5 0 5.5.5 5.9 1H6.1C6.5 5.5 8.5 5 12 5zM6 7h12v6H6zm1.5 9a1.5 1.5 0 110-3 1.5 1.5 0 010 3zm9 0a1.5 1.5 0 110-3 1.5 1.5 0 010 3z"/></svg>
        </div>
        <div>
          <div class="logo-text">DE LIJN</div>
          <div class="logo-sub">Live Tracker</div>
        </div>
      </div>
    </div>

    <div id="status-bar">
      <div class="status-row">
        <div id="live-indicator" class="live-dot">
          <div class="pulse loading" id="pulse-dot"></div>
          <span id="live-text">Connecting…</span>
        </div>
        <div class="status-value" id="last-update">–</div>
      </div>
      <div id="refresh-bar"><div id="refresh-progress" style="width:0%"></div></div>
    </div>

    <div id="stats">
      <div class="stat-card"><div class="stat-num" id="stat-vehicles">–</div><div class="stat-label">Vehicles</div></div>
      <div class="stat-card"><div class="stat-num orange" id="stat-trips">–</div><div class="stat-label">Trips</div></div>
      <div class="stat-card"><div class="stat-num green" id="stat-ontime">–</div><div class="stat-label">On Time</div></div>
      <div class="stat-card"><div class="stat-num red" id="stat-delayed">–</div><div class="stat-label">Delayed</div></div>
    </div>

    <div id="vehicle-list-header">
      <span>Vehicles</span>
      <span id="filter-badge" style="color:var(--accent);"></span>
    </div>

    <div id="vehicle-list">
      <div id="vlist-spacer"></div>
      <div id="vlist-window"></div>
    </div>
  </aside>

  <div id="map"></div>
  <div id="map-branding">Belgium · GTFS-RT</div>
</div>

<div id="toast"></div>

<script>
// ── Config ────────────────────────────────────────────────────────────────────
const REFRESH_INTERVAL = 15000;
const TILE_URL  = "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png";
const TILE_ATTR = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>';
const ITEM_H    = 52; // must match .vehicle-item height in CSS

// ── Colour palette ────────────────────────────────────────────────────────────
const PALETTE = ["#00d4ff","#ff6b35","#a8ff3e","#ff3b88","#ffcc00","#c77dff","#06ffa5","#ff9f43","#48dbfb","#ff6b6b"];

function routeColor(key) {
  let h = 0;
  for (let i = 0; i < key.length; i++) h = (h * 31 + key.charCodeAt(i)) & 0xffffffff;
  return PALETTE[Math.abs(h) % PALETTE.length];
}

function parseRoute(tripId = "") {
  const p = tripId.split("_");
  return p.length >= 2 ? p[1] : tripId.slice(0, 6);
}

function fmtDelay(sec) {
  if (sec == null || sec === 0) return "On time";
  const sign = sec > 0 ? "+" : "−";
  const abs = Math.abs(Math.round(sec));
  return abs < 60 ? `${sign}${abs}s` : `${sign}${Math.floor(abs/60)}m ${abs%60}s`;
}
function fmtSpeed(ms) { return ms == null ? "–" : `${Math.round(ms * 3.6)} km/h`; }
function fmtBearing(deg) {
  if (deg == null) return "–";
  return ["N","NE","E","SE","S","SW","W","NW"][Math.round(deg/45)%8] + ` ${Math.round(deg)}°`;
}

// ── Map ───────────────────────────────────────────────────────────────────────
// Canvas renderer: all markers share ONE <canvas> element — no per-marker DOM nodes
const renderer = L.canvas({ padding: 0.5 });

const map = L.map("map", {
  center: [51.0, 4.3], zoom: 9,
  zoomControl: true, attributionControl: true,
  preferCanvas: true,
});

L.tileLayer(TILE_URL, { attribution: TILE_ATTR, subdomains: "abcd", maxZoom: 19 }).addTo(map);

// ── State ─────────────────────────────────────────────────────────────────────
const markers     = {};  // vehicleId → L.CircleMarker
const vehicleData = {};  // vehicleId → data object
let   sortedList  = [];  // sorted array for virtual scroll
let   delayLookup = {};
let   activeId    = null;
let   refreshTimer = null, progressTimer = null, progressStart = null;

// ── Toast ─────────────────────────────────────────────────────────────────────
let toastTimer = null;
function showToast(msg, isError = false) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.className = "show" + (isError ? " error" : "");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = ""; }, 3500);
}

// ── Progress bar ──────────────────────────────────────────────────────────────
function startProgress() {
  clearInterval(progressTimer);
  progressStart = Date.now();
  const bar = document.getElementById("refresh-progress");
  progressTimer = setInterval(() => {
    const pct = Math.min(100, (Date.now() - progressStart) / REFRESH_INTERVAL * 100);
    bar.style.width = pct + "%";
    if (pct >= 100) clearInterval(progressTimer);
  }, 250);
}

// ── Virtual scroll ────────────────────────────────────────────────────────────
const vListEl   = document.getElementById("vehicle-list");
const vSpacer   = document.getElementById("vlist-spacer");
const vWindow   = document.getElementById("vlist-window");

// Row item cache — reuse DOM nodes instead of creating new ones each scroll
const rowPool = [];
function getRow() { return rowPool.pop() || document.createElement("div"); }
function recycleRow(el) { rowPool.push(el); }

let renderedStart = -1, renderedEnd = -1;

function renderVirtualList(force = false) {
  const total   = sortedList.length;
  const scrollTop = vListEl.scrollTop;
  const viewH   = vListEl.clientHeight;

  const firstVis = Math.floor(scrollTop / ITEM_H);
  const lastVis  = Math.min(total - 1, Math.ceil((scrollTop + viewH) / ITEM_H));
  const bufStart = Math.max(0, firstVis - 5);
  const bufEnd   = Math.min(total - 1, lastVis + 5);

  if (!force && bufStart === renderedStart && bufEnd === renderedEnd) return;

  // Update spacer height so scrollbar is correct
  vSpacer.style.height = (total * ITEM_H) + "px";

  // Recycle rows that are no longer in the window
  const keep = new Set();
  for (let i = bufStart; i <= bufEnd; i++) keep.add(i);

  // Remove old rows
  for (const child of Array.from(vWindow.children)) {
    const idx = parseInt(child.dataset.idx, 10);
    if (!keep.has(idx)) { vWindow.removeChild(child); recycleRow(child); }
  }

  // Add new rows
  const existing = new Set(
    Array.from(vWindow.children).map(c => parseInt(c.dataset.idx, 10))
  );

  for (let i = bufStart; i <= bufEnd; i++) {
    if (existing.has(i)) {
      // Update active state in place
      const child = vWindow.querySelector(`[data-idx="${i}"]`);
      if (child) child.className = "vehicle-item" + (sortedList[i]?.vehicleId === activeId ? " active" : "");
      continue;
    }
    const v = sortedList[i];
    if (!v) continue;

    const row = getRow();
    row.className = "vehicle-item" + (v.vehicleId === activeId ? " active" : "");
    row.dataset.idx = i;
    row.dataset.id  = v.vehicleId;
    row.style.cssText = `position:absolute;top:${i * ITEM_H}px;left:0;right:0;`;

    const isDelayed = v.delay != null && v.delay >= 60;
    const isEarly   = v.delay != null && v.delay < -30;
    const delayColor = isDelayed ? "var(--danger)" : isEarly ? "var(--accent3)" : "var(--text-dim)";

    row.innerHTML = `
      <div class="v-badge" style="background:${v.color}22;color:${v.color};border:1px solid ${v.color}44">${parseRoute(v.tripId)}</div>
      <div class="v-info">
        <div class="v-route">${v.label || v.vehicleId}</div>
        <div class="v-meta">${v.vehicleId}</div>
      </div>
      <div class="v-delay" style="color:${delayColor}">${fmtDelay(v.delay)}</div>`;

    row.addEventListener("click", () => selectVehicle(v.vehicleId));
    vWindow.appendChild(row);
  }

  renderedStart = bufStart;
  renderedEnd   = bufEnd;
}

vListEl.addEventListener("scroll", () => renderVirtualList(), { passive: true });

// ── Fetch & render ────────────────────────────────────────────────────────────
async function fetchAndRender() {
  const pulseDot = document.getElementById("pulse-dot");
  const liveText = document.getElementById("live-text");
  pulseDot.className = "pulse loading";
  liveText.textContent = "Fetching…";

  let data;
  try {
    const resp = await fetch("/api/gtfs", { cache: "no-store" });
    if (!resp.ok) { const e = await resp.json().catch(()=>({})); throw new Error(e.error || `HTTP ${resp.status}`); }
    data = await resp.json();
  } catch (err) {
    pulseDot.className = "pulse error";
    liveText.textContent = "Error";
    showToast("⚠ " + err.message, true);
    return;
  }

  pulseDot.className = "pulse";
  liveText.textContent = "Live";
  document.getElementById("last-update").textContent =
    new Date().toLocaleTimeString("en-GB", { hour:"2-digit", minute:"2-digit", second:"2-digit" });

  processEntities(data.entity || []);
  startProgress();
}

function processEntities(entities) {
  // Build delay lookup
  delayLookup = {};
  let tripCount = 0;
  for (const e of entities) {
    const tu = e.tripUpdate;
    if (!tu) continue;
    tripCount++;
    const tid = tu.trip?.tripId;
    if (!tid) continue;
    const upd = tu.stopTimeUpdate || [];
    if (upd.length) {
      const last = upd[upd.length - 1];
      delayLookup[tid] = last.departure?.delay ?? last.arrival?.delay ?? 0;
    }
  }

  // Collect vehicle data first, then bulk-update markers
  const seen   = new Set();
  let vCount   = 0, onTime = 0, delayed = 0;
  const toAdd  = [];  // [vehicleId, lat, lng, color, delay] — new markers

  for (const e of entities) {
    const vp = e.vehicle;
    if (!vp?.position) continue;
    const { latitude: lat, longitude: lng, bearing, speed } = vp.position;
    if (!lat || !lng) continue;

    vCount++;
    const vehicleId = vp.vehicle?.id || e.id || `v${vCount}`;
    const tripId    = vp.trip?.tripId || "";
    const routeId   = vp.trip?.routeId || parseRoute(tripId);
    const label     = vp.vehicle?.label || parseRoute(tripId);
    const delay     = delayLookup[tripId] ?? null;
    const color     = routeColor(routeId || tripId);

    if (delay != null && Math.abs(delay) < 60) onTime++;
    else if (delay != null && delay >= 60) delayed++;

    seen.add(vehicleId);
    vehicleData[vehicleId] = { vehicleId, tripId, routeId, label, lat, lng, bearing, speed, delay, color };

    if (markers[vehicleId]) {
      // Just move existing marker — no icon rebuild
      markers[vehicleId].setLatLng([lat, lng]);
      // Update color if changed
      markers[vehicleId].setStyle({ color, fillColor: color });
    } else {
      toAdd.push({ vehicleId, lat, lng, color, delay });
    }
  }

  // Batch-add new markers
  for (const { vehicleId, lat, lng, color } of toAdd) {
    const m = L.circleMarker([lat, lng], {
      renderer,        // ← shared canvas renderer
      radius: 6,
      color,
      fillColor: color,
      fillOpacity: 0.85,
      weight: 1.5,
      opacity: 1,
    }).addTo(map);
    m.on("click", () => selectVehicle(vehicleId));
    markers[vehicleId] = m;
  }

  // Remove stale markers
  for (const id of Object.keys(markers)) {
    if (!seen.has(id)) { map.removeLayer(markers[id]); delete markers[id]; delete vehicleData[id]; }
  }

  // Stats
  document.getElementById("stat-vehicles").textContent = vCount;
  document.getElementById("stat-trips").textContent    = tripCount;
  document.getElementById("stat-ontime").textContent   = onTime;
  document.getElementById("stat-delayed").textContent  = delayed;

  // Sidebar virtual list
  sortedList = Object.values(vehicleData).sort((a, b) => (b.delay || 0) - (a.delay || 0));
  document.getElementById("filter-badge").textContent = sortedList.length;
  renderedStart = renderedEnd = -1; // force redraw
  renderVirtualList(true);
}

// ── Select vehicle ────────────────────────────────────────────────────────────
function selectVehicle(id) {
  activeId = id;
  const v = vehicleData[id];
  if (!v) return;

  map.setView([v.lat, v.lng], Math.max(map.getZoom(), 13), { animate: true });

  const delayColor = v.delay != null && v.delay >= 60 ? "var(--danger)"
    : v.delay != null && v.delay < -30 ? "var(--accent3)"
    : "var(--text-dim)";

  markers[id]?.bindPopup(`
    <div class="popup-inner">
      <div class="popup-route" style="color:${v.color}">${parseRoute(v.tripId)}</div>
      <div class="popup-trip">${v.tripId || "–"}</div>
      <div class="popup-grid">
        <div><div class="popup-field-label">Vehicle</div><div class="popup-field-value">${v.vehicleId}</div></div>
        <div><div class="popup-field-label">Delay</div><div class="popup-field-value" style="color:${delayColor}">${fmtDelay(v.delay)}</div></div>
        <div><div class="popup-field-label">Speed</div><div class="popup-field-value">${fmtSpeed(v.speed)}</div></div>
        <div><div class="popup-field-label">Bearing</div><div class="popup-field-value">${fmtBearing(v.bearing)}</div></div>
        <div><div class="popup-field-label">Lat</div><div class="popup-field-value">${v.lat.toFixed(5)}</div></div>
        <div><div class="popup-field-label">Lng</div><div class="popup-field-value">${v.lng.toFixed(5)}</div></div>
      </div>
    </div>`, { maxWidth: 260 }
  ).openPopup();

  // Refresh visible list rows to update active highlight
  renderVirtualList(true);
}

// ── Auto-refresh ──────────────────────────────────────────────────────────────
function scheduleRefresh() {
  clearTimeout(refreshTimer);
  refreshTimer = setTimeout(async () => { await fetchAndRender(); scheduleRefresh(); }, REFRESH_INTERVAL);
}

// ── Boot ──────────────────────────────────────────────────────────────────────
(async () => { await fetchAndRender(); scheduleRefresh(); })();
</script>
</body>
</html>
