<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Geotransport · Live Tracker</title>
  <meta name="description" content="Real-time De Lijn vehicle tracker — positions, delays and cancellations." />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet" />

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #080c10;
      --surface:   #0e1419;
      --surface2:  #141b23;
      --border:    #1e2d3d;
      --accent:    #00d4ff;
      --accent2:   #ff6b35;
      --accent3:   #a8ff3e;
      --muted:     #4a6070;
      --text:      #c8dae8;
      --text-dim:  #6b8899;
      --danger:    #ff3b5c;
      --font-ui:   'Oxanium', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    html, body { width:100%; height:100%; background:var(--bg); color:var(--text); font-family:var(--font-ui); overflow:hidden; }
    #app { position:relative; width:100vw; height:100vh; display:flex; }
    #map { flex:1; height:100%; background:var(--bg); z-index:1; }

    /* ── Sidebar ── */
    #sidebar {
      position:absolute; top:0; left:0; bottom:0; width:290px;
      background:linear-gradient(180deg,rgba(8,12,16,0.97) 0%,rgba(14,20,25,0.95) 100%);
      border-right:1px solid var(--border);
      display:flex; flex-direction:column; z-index:100;
      backdrop-filter:blur(12px);
    }

    /* ── Header ── */
    #header { padding:18px 20px 14px; border-bottom:1px solid var(--border); flex-shrink:0; }
    .logo-row { display:flex; align-items:center; gap:10px; }
    .logo-icon {
      width:34px; height:34px; background:var(--accent);
      clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
      display:flex; align-items:center; justify-content:center; flex-shrink:0;
    }
    .logo-icon svg { width:20px; height:20px; fill:var(--bg); }
    .logo-text { font-size:20px; font-weight:700; letter-spacing:0.12em; color:#fff; text-transform:uppercase; }
    .logo-sub { font-size:9px; letter-spacing:0.25em; text-transform:uppercase; color:var(--accent); font-family:var(--font-mono); margin-top:2px; }

    /* ── Status bar ── */
    #status-bar { padding:10px 20px; border-bottom:1px solid var(--border); flex-shrink:0; }
    .status-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; }
    .status-value { font-size:12px; font-weight:600; font-family:var(--font-mono); color:var(--text-dim); }
    .live-dot { display:inline-flex; align-items:center; gap:6px; font-size:10px; letter-spacing:0.1em; text-transform:uppercase; font-family:var(--font-mono); }
    .pulse { width:7px; height:7px; border-radius:50%; background:var(--accent3); animation:pulseAnim 2s infinite; }
    .pulse.error { background:var(--danger); animation:none; box-shadow:0 0 0 0 rgba(255,59,92,0.4); }
    .pulse.loading { background:var(--accent); animation:spin 1s linear infinite; }
    @keyframes pulseAnim { 0%{box-shadow:0 0 0 0 rgba(168,255,62,0.6)} 70%{box-shadow:0 0 0 8px rgba(168,255,62,0)} 100%{box-shadow:0 0 0 0 rgba(168,255,62,0)} }
    @keyframes spin { to{transform:rotate(360deg)} }
    #refresh-bar { height:2px; background:var(--border); border-radius:1px; margin-top:6px; overflow:hidden; }
    #refresh-progress { height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:1px; transition:width 1s linear; }

    /* ── Stats grid ── */
    #stats {
      padding:12px 20px; border-bottom:1px solid var(--border);
      display:grid; grid-template-columns:repeat(3,1fr); gap:8px; flex-shrink:0;
    }
    .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:6px; padding:8px 10px; }
    .stat-num { font-size:20px; font-weight:700; font-family:var(--font-mono); color:var(--accent); line-height:1; }
    .stat-num.orange{color:var(--accent2)} .stat-num.green{color:var(--accent3)} .stat-num.red{color:var(--danger)} .stat-num.yellow{color:#ffcc00}
    .stat-label { font-size:8px; letter-spacing:0.15em; text-transform:uppercase; color:var(--text-dim); margin-top:3px; font-family:var(--font-mono); }

    /* ── Tab bar ── */
    #tabs {
      display:flex; flex-shrink:0; border-bottom:1px solid var(--border);
    }
    .tab {
      flex:1; padding:9px 0; text-align:center; font-size:10px; font-family:var(--font-mono);
      letter-spacing:0.12em; text-transform:uppercase; color:var(--text-dim);
      cursor:pointer; border-bottom:2px solid transparent; transition:all 0.15s;
      user-select:none;
    }
    .tab:hover { color:var(--text); background:rgba(255,255,255,0.02); }
    .tab.active { color:var(--accent); border-bottom-color:var(--accent); }
    .tab.canceled-tab.active { color:var(--danger); border-bottom-color:var(--danger); }
    .tab-badge {
      display:inline-block; margin-left:5px; padding:1px 5px;
      background:var(--surface2); border-radius:10px; font-size:9px;
    }
    .tab.active .tab-badge { background:rgba(0,212,255,0.15); color:var(--accent); }
    .tab.canceled-tab.active .tab-badge { background:rgba(255,59,92,0.15); color:var(--danger); }

    /* ── Virtual list ── */
    .list-pane { display:none; flex:1; overflow-y:auto; scrollbar-width:thin; scrollbar-color:var(--border) transparent; position:relative; }
    .list-pane.visible { display:block; }
    .list-pane::-webkit-scrollbar{width:4px}
    .list-pane::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
    .vlist-spacer { width:1px; }
    .vlist-window { position:absolute; top:0; left:0; right:0; }

    /* ── Vehicle rows ── */
    .vehicle-item {
      padding:10px 18px; border-bottom:1px solid rgba(30,45,61,0.5);
      cursor:pointer; transition:background 0.12s; display:flex; align-items:center; gap:10px;
      height:52px;
    }
    .vehicle-item:hover { background:rgba(0,212,255,0.04); }
    .vehicle-item.active { background:rgba(0,212,255,0.08); border-left:2px solid var(--accent); padding-left:16px; }

    /* ── Canceled rows ── */
    .canceled-item {
      padding:9px 18px; border-bottom:1px solid rgba(30,45,61,0.4);
      display:flex; align-items:center; gap:10px; height:48px;
    }
    .canceled-item.cursor-click { cursor:pointer; transition:background 0.12s; }
    .canceled-item.cursor-click:hover { background:rgba(255,59,92,0.04); }

    .v-badge { width:38px;height:22px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;font-family:var(--font-mono);flex-shrink:0; }
    .v-info { flex:1;min-width:0; }
    .v-route { font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
    .v-meta { font-size:10px;color:var(--text-dim);font-family:var(--font-mono);white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
    .v-delay { font-size:11px;font-family:var(--font-mono);font-weight:500;flex-shrink:0; }
    .v-canceled-badge {
      font-size:9px;font-family:var(--font-mono);font-weight:600;letter-spacing:0.1em;
      color:var(--danger);background:rgba(255,59,92,0.12);border:1px solid rgba(255,59,92,0.3);
      border-radius:3px;padding:2px 5px;flex-shrink:0;text-transform:uppercase;
    }

    /* ── Popups ── */
    .leaflet-popup-content-wrapper{background:var(--surface)!important;border:1px solid var(--accent)!important;border-radius:8px!important;box-shadow:0 4px 32px rgba(0,212,255,0.2)!important;color:var(--text)!important;font-family:var(--font-ui)!important;padding:0!important}
    .leaflet-popup-tip{background:var(--accent)!important}
    .leaflet-popup-content{margin:0!important;line-height:1.4!important}
    .popup-inner{padding:14px 16px;min-width:210px}
    .popup-route{font-size:20px;font-weight:700;font-family:var(--font-ui);margin-bottom:2px}
    .popup-trip{font-size:10px;color:var(--text-dim);font-family:var(--font-mono);margin-bottom:10px;word-break:break-all}
    .popup-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .popup-field-label{font-size:9px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);font-family:var(--font-mono)}
    .popup-field-value{font-size:13px;font-weight:600;font-family:var(--font-mono);color:var(--text)}
    .popup-canceled-banner{background:rgba(255,59,92,0.1);border:1px solid rgba(255,59,92,0.3);border-radius:5px;padding:7px 10px;margin-bottom:10px;font-size:11px;font-family:var(--font-mono);color:var(--danger);letter-spacing:0.1em;text-transform:uppercase;text-align:center}

    .leaflet-control-attribution{background:rgba(8,12,16,0.8)!important;color:var(--muted)!important;font-size:10px!important}
    .leaflet-control-attribution a{color:var(--accent)!important}
    .leaflet-control-zoom a{background:var(--surface)!important;border-color:var(--border)!important;color:var(--text)!important}
    .leaflet-control-zoom a:hover{background:var(--surface2)!important}

    /* ── Toast ── */
    #toast{position:fixed;bottom:24px;right:24px;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:12px 16px;font-size:12px;font-family:var(--font-mono);color:var(--text);z-index:9999;opacity:0;transform:translateY(8px);transition:opacity 0.2s,transform 0.2s;pointer-events:none;max-width:320px}
    #toast.show{opacity:1;transform:translateY(0)}
    #toast.error{border-color:var(--danger);color:var(--danger)}

    #map-branding{position:absolute;bottom:32px;left:306px;z-index:50;font-family:var(--font-ui);font-size:11px;font-weight:300;letter-spacing:0.3em;text-transform:uppercase;color:rgba(200,218,232,0.2);pointer-events:none}
  </style>
</head>
<body>
<div id="app">
  <aside id="sidebar">

    <div id="header">
      <div class="logo-row">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24"><path d="M12 2C8 2 4 2.5 4 6v10c0 1.1.9 2 2 2h1l1 2h8l1-2h1c1.1 0 2-.9 2-2V6c0-3.5-4-4-8-4zm0 2c3.8 0 5.8.5 6 1.5H6C6.2 5.5 8.2 5 12 5zM6 8h12v5H6V8zm1.5 8a1.5 1.5 0 110-3 1.5 1.5 0 010 3zm9 0a1.5 1.5 0 110-3 1.5 1.5 0 010 3z"/></svg>
        </div>
        <div>
          <div class="logo-text">Geotransport</div>
          <div class="logo-sub">De Lijn · Live</div>
        </div>
      </div>
    </div>

    <div id="status-bar">
      <div class="status-row">
        <div class="live-dot">
          <div class="pulse loading" id="pulse-dot"></div>
          <span id="live-text">Connecting…</span>
        </div>
        <div class="status-value" id="last-update">–</div>
      </div>
      <div id="refresh-bar"><div id="refresh-progress" style="width:0%"></div></div>
    </div>

    <div id="stats">
      <div class="stat-card"><div class="stat-num" id="stat-vehicles">–</div><div class="stat-label">Active</div></div>
      <div class="stat-card"><div class="stat-num green" id="stat-ontime">–</div><div class="stat-label">On Time</div></div>
      <div class="stat-card"><div class="stat-num orange" id="stat-delayed">–</div><div class="stat-label">Delayed</div></div>
      <div class="stat-card"><div class="stat-num red" id="stat-canceled">–</div><div class="stat-label">Canceled</div></div>
      <div class="stat-card"><div class="stat-num yellow" id="stat-trips">–</div><div class="stat-label">Trips</div></div>
      <div class="stat-card"><div class="stat-num" style="color:var(--text-dim)" id="stat-entities">–</div><div class="stat-label">Entities</div></div>
    </div>

    <div id="tabs">
      <div class="tab active" id="tab-vehicles" onclick="switchTab('vehicles')">
        Vehicles <span class="tab-badge" id="badge-vehicles">0</span>
      </div>
      <div class="tab canceled-tab" id="tab-canceled" onclick="switchTab('canceled')">
        Canceled <span class="tab-badge" id="badge-canceled">0</span>
      </div>
    </div>

    <div class="list-pane visible" id="pane-vehicles">
      <div class="vlist-spacer" id="vlist-spacer-v"></div>
      <div class="vlist-window" id="vlist-window-v"></div>
    </div>

    <div class="list-pane" id="pane-canceled">
      <div class="vlist-spacer" id="vlist-spacer-c"></div>
      <div class="vlist-window" id="vlist-window-c"></div>
    </div>

  </aside>

  <div id="map"></div>
  <div id="map-branding">Belgium · GTFS-RT</div>
</div>

<div id="toast"></div>

<script>
// ── Config ────────────────────────────────────────────────────────────────────
const REFRESH_INTERVAL = 15000;
const TILE_URL  = "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png";
const TILE_ATTR = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>';
const ITEM_H_V = 52;  // vehicle row height
const ITEM_H_C = 48;  // canceled row height

// schedule_relationship values
const SR_SCHEDULED  = 0;
const SR_ADDED      = 1;
const SR_UNSCHEDULED= 2;
const SR_CANCELED   = 3;

// ── Colours ───────────────────────────────────────────────────────────────────
const PALETTE = ["#00d4ff","#ff6b35","#a8ff3e","#ff3b88","#ffcc00","#c77dff","#06ffa5","#ff9f43","#48dbfb","#ff6b6b"];
function routeColor(key) {
  let h = 0;
  for (let i = 0; i < key.length; i++) h = (h * 31 + key.charCodeAt(i)) & 0xffffffff;
  return PALETTE[Math.abs(h) % PALETTE.length];
}

function parseRoute(tripId = "") {
  const p = tripId.split("_");
  return p.length >= 2 ? p[1] : tripId.slice(0, 6);
}

function fmtDelay(sec) {
  if (sec == null || sec === 0) return "On time";
  const sign = sec > 0 ? "+" : "−";
  const abs = Math.abs(Math.round(sec));
  return abs < 60 ? `${sign}${abs}s` : `${sign}${Math.floor(abs/60)}m ${abs%60}s`;
}
function fmtSpeed(ms) { return ms == null ? "–" : `${Math.round(ms * 3.6)} km/h`; }
function fmtBearing(deg) {
  if (deg == null) return "–";
  return ["N","NE","E","SE","S","SW","W","NW"][Math.round(deg / 45) % 8] + ` ${Math.round(deg)}°`;
}

// ── Map ───────────────────────────────────────────────────────────────────────
const renderer = L.canvas({ padding: 0.5 });
const map = L.map("map", {
  center: [51.0, 4.3], zoom: 9,
  zoomControl: true, attributionControl: true,
  preferCanvas: true,
});
L.tileLayer(TILE_URL, { attribution: TILE_ATTR, subdomains: "abcd", maxZoom: 19 }).addTo(map);

// ── State ─────────────────────────────────────────────────────────────────────
const markers      = {};  // vehicleId → L.CircleMarker  (active vehicles)
const vehicleData  = {};  // vehicleId → vehicle info
const canceledData = {};  // tripId    → canceled trip info
let   sortedVehicles  = [];
let   sortedCanceled  = [];
let   delayLookup     = {};
let   activeId        = null;
let   activeTab       = "vehicles";
let   refreshTimer    = null, progressTimer = null, progressStart = null;

// ── Toast ─────────────────────────────────────────────────────────────────────
let toastTimer = null;
function showToast(msg, isError = false) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.className = "show" + (isError ? " error" : "");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = ""; }, 3500);
}

// ── Tabs ──────────────────────────────────────────────────────────────────────
function switchTab(tab) {
  activeTab = tab;
  document.getElementById("tab-vehicles").className = "tab" + (tab === "vehicles" ? " active" : "");
  document.getElementById("tab-canceled").className = "tab canceled-tab" + (tab === "canceled" ? " active" : "");
  document.getElementById("pane-vehicles").className = "list-pane" + (tab === "vehicles" ? " visible" : "");
  document.getElementById("pane-canceled").className = "list-pane" + (tab === "canceled" ? " visible" : "");
}

// ── Progress bar ──────────────────────────────────────────────────────────────
function startProgress() {
  clearInterval(progressTimer);
  progressStart = Date.now();
  const bar = document.getElementById("refresh-progress");
  progressTimer = setInterval(() => {
    const pct = Math.min(100, (Date.now() - progressStart) / REFRESH_INTERVAL * 100);
    bar.style.width = pct + "%";
    if (pct >= 100) clearInterval(progressTimer);
  }, 250);
}

// ── Virtual scroll ────────────────────────────────────────────────────────────
const rowPool = [];
function getRow() { return rowPool.pop() || document.createElement("div"); }
function recycleRow(el) { rowPool.push(el); }

function makeVirtualList(paneId, spacerId, windowId, items, itemH, renderRow) {
  const pane   = document.getElementById(paneId);
  const spacer = document.getElementById(spacerId);
  const win    = document.getElementById(windowId);

  spacer.style.height = (items.length * itemH) + "px";

  const scrollTop = pane.scrollTop;
  const viewH     = pane.clientHeight;
  const firstVis  = Math.floor(scrollTop / itemH);
  const lastVis   = Math.min(items.length - 1, Math.ceil((scrollTop + viewH) / itemH));
  const bufStart  = Math.max(0, firstVis - 4);
  const bufEnd    = Math.min(items.length - 1, lastVis + 4);
  const keep      = new Set();
  for (let i = bufStart; i <= bufEnd; i++) keep.add(i);

  // Remove out-of-window rows
  for (const child of Array.from(win.children)) {
    const idx = parseInt(child.dataset.idx, 10);
    if (!keep.has(idx)) { win.removeChild(child); recycleRow(child); }
  }

  // Add new rows
  const existing = new Set(Array.from(win.children).map(c => parseInt(c.dataset.idx, 10)));
  for (let i = bufStart; i <= bufEnd; i++) {
    if (existing.has(i)) continue;
    const item = items[i];
    if (!item) continue;
    const row = getRow();
    renderRow(row, item, i);
    row.dataset.idx  = i;
    row.style.cssText = `position:absolute;top:${i * itemH}px;left:0;right:0;`;
    win.appendChild(row);
  }
}

// ── Render vehicle row ────────────────────────────────────────────────────────
function renderVehicleRow(row, v) {
  const isDelayed = v.delay != null && v.delay >= 60;
  const isEarly   = v.delay != null && v.delay < -30;
  const delayColor = isDelayed ? "var(--danger)" : isEarly ? "var(--accent3)" : "var(--text-dim)";
  row.className = "vehicle-item" + (v.vehicleId === activeId ? " active" : "");
  row.dataset.id = v.vehicleId;
  row.onclick = () => selectVehicle(v.vehicleId);
  row.innerHTML = `
    <div class="v-badge" style="background:${v.color}22;color:${v.color};border:1px solid ${v.color}44">${parseRoute(v.tripId)}</div>
    <div class="v-info">
      <div class="v-route">${v.label || v.vehicleId}</div>
      <div class="v-meta">${v.vehicleId}</div>
    </div>
    <div class="v-delay" style="color:${delayColor}">${fmtDelay(v.delay)}</div>`;
}

// ── Render canceled row ───────────────────────────────────────────────────────
function renderCanceledRow(row, c) {
  const color = routeColor(c.routeId || c.tripId);
  row.className = "canceled-item";
  row.dataset.id = c.tripId;
  row.innerHTML = `
    <div class="v-badge" style="background:rgba(255,59,92,0.1);color:var(--danger);border:1px solid rgba(255,59,92,0.3)">${parseRoute(c.tripId)}</div>
    <div class="v-info">
      <div class="v-route" style="color:var(--text-dim);text-decoration:line-through">${c.tripId.split('_').slice(0,3).join('_') || c.tripId}</div>
      <div class="v-meta">${c.startDate || '–'} · ${c.startTime || '–'}</div>
    </div>
    <div class="v-canceled-badge">Canceled</div>`;
}

// ── Refresh virtual lists ─────────────────────────────────────────────────────
function refreshLists() {
  makeVirtualList("pane-vehicles", "vlist-spacer-v", "vlist-window-v",
    sortedVehicles, ITEM_H_V, renderVehicleRow);
  makeVirtualList("pane-canceled", "vlist-spacer-c", "vlist-window-c",
    sortedCanceled, ITEM_H_C, renderCanceledRow);
}

document.getElementById("pane-vehicles").addEventListener("scroll", () => {
  makeVirtualList("pane-vehicles","vlist-spacer-v","vlist-window-v",sortedVehicles,ITEM_H_V,renderVehicleRow);
}, { passive: true });
document.getElementById("pane-canceled").addEventListener("scroll", () => {
  makeVirtualList("pane-canceled","vlist-spacer-c","vlist-window-c",sortedCanceled,ITEM_H_C,renderCanceledRow);
}, { passive: true });

// ── Fetch & render ────────────────────────────────────────────────────────────
async function fetchAndRender() {
  const pulseDot = document.getElementById("pulse-dot");
  const liveText = document.getElementById("live-text");
  pulseDot.className = "pulse loading";
  liveText.textContent = "Fetching…";

  let data;
  try {
    const resp = await fetch("/api/gtfs", { cache: "no-store" });
    if (!resp.ok) { const e = await resp.json().catch(()=>({})); throw new Error(e.error || `HTTP ${resp.status}`); }
    data = await resp.json();
  } catch (err) {
    pulseDot.className = "pulse error";
    liveText.textContent = "Error";
    showToast("⚠ " + err.message, true);
    return;
  }

  pulseDot.className = "pulse";
  liveText.textContent = "Live";
  document.getElementById("last-update").textContent =
    new Date().toLocaleTimeString("en-GB", { hour:"2-digit", minute:"2-digit", second:"2-digit" });

  processEntities(data.entity || []);
  startProgress();
}

// ── Process entities ──────────────────────────────────────────────────────────
function processEntities(entities) {
  // ── Pass 1: delay lookup from TripUpdates ─────────────────────────────
  delayLookup = {};
  let tripCount = 0;
  const newCanceled = {};

  for (const e of entities) {
    const tu = e.tripUpdate;
    if (!tu) continue;
    tripCount++;

    const trip     = tu.trip || {};
    const tripId   = trip.tripId   || "";
    const routeId  = trip.routeId  || parseRoute(tripId);
    const startDate= trip.startDate|| "";
    const startTime= trip.startTime|| "";
    const schedRel = trip.scheduleRelationship ?? SR_SCHEDULED;

    if (schedRel === SR_CANCELED) {
      // Canceled trip — no position, just meta
      newCanceled[tripId] = { tripId, routeId, startDate, startTime, schedRel };
    } else {
      // Build delay lookup for position matching
      const upd = tu.stopTimeUpdate || [];
      if (upd.length) {
        const last = upd[upd.length - 1];
        delayLookup[tripId] = last.departure?.delay ?? last.arrival?.delay ?? 0;
      }
    }
  }

  // ── Pass 2: VehiclePositions ─────────────────────────────────────────
  const seen = new Set();
  let vCount = 0, onTime = 0, delayed = 0;

  for (const e of entities) {
    const vp = e.vehicle;
    if (!vp?.position) continue;
    const { latitude: lat, longitude: lng, bearing, speed } = vp.position;
    if (!lat || !lng) continue;

    vCount++;
    const vehicleId = vp.vehicle?.id || e.id || `v${vCount}`;
    const tripId    = vp.trip?.tripId  || "";
    const routeId   = vp.trip?.routeId || parseRoute(tripId);
    const label     = vp.vehicle?.label || parseRoute(tripId);
    const delay     = delayLookup[tripId] ?? null;
    const color     = routeColor(routeId || tripId);

    if (delay != null && Math.abs(delay) < 60) onTime++;
    else if (delay != null && delay >= 60) delayed++;

    seen.add(vehicleId);
    vehicleData[vehicleId] = { vehicleId, tripId, routeId, label, lat, lng, bearing, speed, delay, color };

    if (markers[vehicleId]) {
      markers[vehicleId].setLatLng([lat, lng]);
      markers[vehicleId].setStyle({ color, fillColor: color });
    } else {
      const m = L.circleMarker([lat, lng], {
        renderer, radius: 6,
        color, fillColor: color,
        fillOpacity: 0.85, weight: 1.5, opacity: 1,
      }).addTo(map);
      m.on("click", () => selectVehicle(vehicleId));
      markers[vehicleId] = m;
    }
  }

  // Remove stale vehicle markers
  for (const id of Object.keys(markers)) {
    if (!seen.has(id)) {
      map.removeLayer(markers[id]);
      delete markers[id];
      delete vehicleData[id];
    }
  }

  // Update canceled data (merge — keep previous if not updated)
  for (const k of Object.keys(canceledData)) delete canceledData[k];
  Object.assign(canceledData, newCanceled);

  // ── Stats ─────────────────────────────────────────────────────────────
  const canceledCount = Object.keys(canceledData).length;
  document.getElementById("stat-vehicles").textContent  = vCount;
  document.getElementById("stat-ontime").textContent    = onTime;
  document.getElementById("stat-delayed").textContent   = delayed;
  document.getElementById("stat-canceled").textContent  = canceledCount;
  document.getElementById("stat-trips").textContent     = tripCount;
  document.getElementById("stat-entities").textContent  = entities.length;

  // ── Sorted lists ──────────────────────────────────────────────────────
  sortedVehicles = Object.values(vehicleData).sort((a, b) => (b.delay || 0) - (a.delay || 0));
  sortedCanceled = Object.values(canceledData).sort((a, b) => a.tripId.localeCompare(b.tripId));

  document.getElementById("badge-vehicles").textContent = sortedVehicles.length;
  document.getElementById("badge-canceled").textContent = canceledCount;

  // Auto-switch to canceled tab if there are cancellations and user is already on it
  // (don't auto-switch away from vehicles)
  refreshLists();
}

// ── Select vehicle ────────────────────────────────────────────────────────────
function selectVehicle(id) {
  activeId = id;
  const v = vehicleData[id];
  if (!v) return;

  map.setView([v.lat, v.lng], Math.max(map.getZoom(), 13), { animate: true });

  const delayColor = v.delay != null && v.delay >= 60 ? "var(--danger)"
    : v.delay != null && v.delay < -30 ? "var(--accent3)"
    : "var(--text-dim)";

  markers[id]?.bindPopup(`
    <div class="popup-inner">
      <div class="popup-route" style="color:${v.color}">${parseRoute(v.tripId)}</div>
      <div class="popup-trip">${v.tripId || "–"}</div>
      <div class="popup-grid">
        <div><div class="popup-field-label">Vehicle</div><div class="popup-field-value">${v.vehicleId}</div></div>
        <div><div class="popup-field-label">Delay</div><div class="popup-field-value" style="color:${delayColor}">${fmtDelay(v.delay)}</div></div>
        <div><div class="popup-field-label">Speed</div><div class="popup-field-value">${fmtSpeed(v.speed)}</div></div>
        <div><div class="popup-field-label">Bearing</div><div class="popup-field-value">${fmtBearing(v.bearing)}</div></div>
        <div><div class="popup-field-label">Lat</div><div class="popup-field-value">${v.lat.toFixed(5)}</div></div>
        <div><div class="popup-field-label">Lng</div><div class="popup-field-value">${v.lng.toFixed(5)}</div></div>
      </div>
    </div>`, { maxWidth: 260 }
  ).openPopup();

  refreshLists();
}

// ── Auto-refresh ──────────────────────────────────────────────────────────────
function scheduleRefresh() {
  clearTimeout(refreshTimer);
  refreshTimer = setTimeout(async () => { await fetchAndRender(); scheduleRefresh(); }, REFRESH_INTERVAL);
}

(async () => { await fetchAndRender(); scheduleRefresh(); })();
</script>
</body>
</html>
