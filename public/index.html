<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>De Lijn · Live Tracker</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet" />

  <style>
    /* ── Reset & base ──────────────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #080c10;
      --surface:   #0e1419;
      --surface2:  #141b23;
      --border:    #1e2d3d;
      --accent:    #00d4ff;
      --accent2:   #ff6b35;
      --accent3:   #a8ff3e;
      --muted:     #4a6070;
      --text:      #c8dae8;
      --text-dim:  #6b8899;
      --danger:    #ff3b5c;
      --font-ui:   'Oxanium', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    html, body {
      width: 100%; height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-ui);
      overflow: hidden;
    }

    /* ── Layout ────────────────────────────────────────────────────────── */
    #app {
      position: relative;
      width: 100vw; height: 100vh;
      display: flex;
    }

    #map {
      flex: 1;
      height: 100%;
      background: var(--bg);
      z-index: 1;
    }

    /* ── Sidebar ───────────────────────────────────────────────────────── */
    #sidebar {
      position: absolute;
      top: 0; left: 0; bottom: 0;
      width: 280px;
      background: linear-gradient(180deg, rgba(8,12,16,0.97) 0%, rgba(14,20,25,0.95) 100%);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 100;
      backdrop-filter: blur(12px);
    }

    /* ── Header ────────────────────────────────────────────────────────── */
    #header {
      padding: 20px 20px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .logo-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .logo-icon {
      width: 32px; height: 32px;
      background: var(--accent);
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .logo-icon svg {
      width: 18px; height: 18px;
      fill: var(--bg);
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: #fff;
    }

    .logo-sub {
      font-size: 10px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--accent);
      font-family: var(--font-mono);
    }

    /* ── Status bar ────────────────────────────────────────────────────── */
    #status-bar {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .status-label {
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-dim);
      font-family: var(--font-mono);
    }

    .status-value {
      font-size: 13px;
      font-weight: 600;
      font-family: var(--font-mono);
      color: var(--text);
    }

    /* Live pulse indicator */
    .live-dot {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-family: var(--font-mono);
    }

    .pulse {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--accent3);
      box-shadow: 0 0 0 0 rgba(168,255,62,0.4);
      animation: pulseAnim 2s infinite;
    }

    .pulse.error { background: var(--danger); box-shadow: 0 0 0 0 rgba(255,59,92,0.4); }
    .pulse.loading { background: var(--accent); box-shadow: 0 0 0 0 rgba(0,212,255,0.4); animation: spin 1s linear infinite; border-radius: 50%; }

    @keyframes pulseAnim {
      0%   { box-shadow: 0 0 0 0 rgba(168,255,62,0.6); }
      70%  { box-shadow: 0 0 0 8px rgba(168,255,62,0); }
      100% { box-shadow: 0 0 0 0 rgba(168,255,62,0); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress bar */
    #refresh-bar {
      height: 2px;
      background: var(--border);
      border-radius: 1px;
      margin-top: 8px;
      overflow: hidden;
    }

    #refresh-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 1px;
      transition: width 1s linear;
    }

    /* ── Stats grid ────────────────────────────────────────────────────── */
    #stats {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      flex-shrink: 0;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
    }

    .stat-num {
      font-size: 22px;
      font-weight: 700;
      font-family: var(--font-mono);
      color: var(--accent);
      line-height: 1;
    }

    .stat-num.orange { color: var(--accent2); }
    .stat-num.green  { color: var(--accent3); }
    .stat-num.red    { color: var(--danger); }

    .stat-label {
      font-size: 9px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-top: 4px;
      font-family: var(--font-mono);
    }

    /* ── Vehicle list ──────────────────────────────────────────────────── */
    #vehicle-list-header {
      padding: 10px 20px 8px;
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-dim);
      font-family: var(--font-mono);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #vehicle-list {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    #vehicle-list::-webkit-scrollbar { width: 4px; }
    #vehicle-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .vehicle-item {
      padding: 10px 20px;
      border-bottom: 1px solid rgba(30,45,61,0.5);
      cursor: pointer;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .vehicle-item:hover {
      background: rgba(0,212,255,0.04);
    }

    .vehicle-item.active {
      background: rgba(0,212,255,0.08);
      border-left: 2px solid var(--accent);
      padding-left: 18px;
    }

    .v-badge {
      width: 36px; height: 22px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      font-family: var(--font-mono);
      flex-shrink: 0;
    }

    .v-info { flex: 1; min-width: 0; }

    .v-route {
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .v-meta {
      font-size: 10px;
      color: var(--text-dim);
      font-family: var(--font-mono);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .v-delay {
      font-size: 11px;
      font-family: var(--font-mono);
      font-weight: 500;
      flex-shrink: 0;
    }

    /* ── Map popup ─────────────────────────────────────────────────────── */
    .leaflet-popup-content-wrapper {
      background: var(--surface) !important;
      border: 1px solid var(--accent) !important;
      border-radius: 8px !important;
      box-shadow: 0 4px 32px rgba(0,212,255,0.2) !important;
      color: var(--text) !important;
      font-family: var(--font-ui) !important;
      padding: 0 !important;
    }

    .leaflet-popup-tip {
      background: var(--accent) !important;
    }

    .leaflet-popup-content {
      margin: 0 !important;
      line-height: 1.4 !important;
    }

    .popup-inner {
      padding: 14px 16px;
      min-width: 200px;
    }

    .popup-route {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
      font-family: var(--font-ui);
      margin-bottom: 2px;
    }

    .popup-trip {
      font-size: 10px;
      color: var(--text-dim);
      font-family: var(--font-mono);
      margin-bottom: 10px;
      word-break: break-all;
    }

    .popup-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .popup-field-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-dim);
      font-family: var(--font-mono);
    }

    .popup-field-value {
      font-size: 13px;
      font-weight: 600;
      font-family: var(--font-mono);
      color: var(--text);
    }

    /* ── Leaflet overrides ─────────────────────────────────────────────── */
    .leaflet-control-attribution {
      background: rgba(8,12,16,0.8) !important;
      color: var(--muted) !important;
      font-size: 10px !important;
    }

    .leaflet-control-attribution a { color: var(--accent) !important; }

    .leaflet-control-zoom a {
      background: var(--surface) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
    }

    .leaflet-control-zoom a:hover {
      background: var(--surface2) !important;
    }

    /* ── Toast ─────────────────────────────────────────────────────────── */
    #toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 12px;
      font-family: var(--font-mono);
      color: var(--text);
      z-index: 9999;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
      max-width: 320px;
    }

    #toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    #toast.error { border-color: var(--danger); color: var(--danger); }

    /* ── Map watermark ─────────────────────────────────────────────────── */
    #map-branding {
      position: absolute;
      bottom: 32px;
      left: 296px;
      z-index: 50;
      font-family: var(--font-ui);
      font-size: 11px;
      font-weight: 300;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: rgba(200,218,232,0.25);
      pointer-events: none;
    }

    /* ── Responsive ────────────────────────────────────────────────────── */
    @media (max-width: 600px) {
      #sidebar { width: 100%; height: auto; bottom: auto; }
      #map { margin-top: 140px; height: calc(100vh - 140px); }
      #vehicle-list { display: none; }
    }
  </style>
</head>
<body>
<div id="app">

  <!-- Sidebar -->
  <aside id="sidebar">

    <!-- Header -->
    <div id="header">
      <div class="logo-row">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24"><path d="M4 16c0 1.1.9 2 2 2h1l1 2h8l1-2h1c1.1 0 2-.9 2-2V6c0-3.5-3.6-4-8-4S4 2.5 4 6zm8-11c3.5 0 5.5.5 5.9 1H6.1C6.5 5.5 8.5 5 12 5zM6 7h12v6H6zm1.5 9a1.5 1.5 0 110-3 1.5 1.5 0 010 3zm9 0a1.5 1.5 0 110-3 1.5 1.5 0 010 3z"/></svg>
        </div>
        <div>
          <div class="logo-text">DE LIJN</div>
          <div class="logo-sub">Live Tracker</div>
        </div>
      </div>
    </div>

    <!-- Status bar -->
    <div id="status-bar">
      <div class="status-row">
        <div id="live-indicator" class="live-dot">
          <div class="pulse loading" id="pulse-dot"></div>
          <span id="live-text">Connecting…</span>
        </div>
        <div class="status-value" id="last-update">–</div>
      </div>
      <div id="refresh-bar">
        <div id="refresh-progress" style="width:0%"></div>
      </div>
    </div>

    <!-- Stats -->
    <div id="stats">
      <div class="stat-card">
        <div class="stat-num" id="stat-vehicles">–</div>
        <div class="stat-label">Vehicles</div>
      </div>
      <div class="stat-card">
        <div class="stat-num orange" id="stat-trips">–</div>
        <div class="stat-label">Trips</div>
      </div>
      <div class="stat-card">
        <div class="stat-num green" id="stat-ontime">–</div>
        <div class="stat-label">On Time</div>
      </div>
      <div class="stat-card">
        <div class="stat-num red" id="stat-delayed">–</div>
        <div class="stat-label">Delayed</div>
      </div>
    </div>

    <!-- Vehicle list header -->
    <div id="vehicle-list-header">
      <span>Vehicles</span>
      <span id="filter-badge" style="color:var(--accent);"></span>
    </div>

    <!-- Vehicle list -->
    <div id="vehicle-list"></div>

  </aside>

  <!-- Map -->
  <div id="map"></div>

  <!-- Map branding -->
  <div id="map-branding">Belgium · GTFS-RT</div>

</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// ── Config ──────────────────────────────────────────────────────────────────
const REFRESH_INTERVAL = 15000; // 15 seconds
const TILE_URL = "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png";
const TILE_ATTR = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>';

// ── Route colour palette ────────────────────────────────────────────────────
const ROUTE_COLORS = [
  "#00d4ff","#ff6b35","#a8ff3e","#ff3b88","#ffcc00",
  "#c77dff","#06ffa5","#ff9f43","#48dbfb","#ff6b6b",
];

function routeColor(routeIdOrTrip) {
  let hash = 0;
  for (let i = 0; i < routeIdOrTrip.length; i++) {
    hash = (hash * 31 + routeIdOrTrip.charCodeAt(i)) & 0xffffffff;
  }
  return ROUTE_COLORS[Math.abs(hash) % ROUTE_COLORS.length];
}

// Parse short route name from tripId e.g. "2026-02-25_2850_181" → "2850"
function parseRoute(tripId = "") {
  const parts = tripId.split("_");
  return parts.length >= 2 ? parts[1] : tripId.slice(0, 6);
}

// Format delay in seconds → "+2m 10s" / "–30s" / "On time"
function fmtDelay(sec) {
  if (sec == null || sec === 0) return "On time";
  const sign = sec > 0 ? "+" : "−";
  const abs = Math.abs(Math.round(sec));
  if (abs < 60) return `${sign}${abs}s`;
  return `${sign}${Math.floor(abs/60)}m ${abs%60}s`;
}

function fmtSpeed(ms) {
  if (ms == null) return "–";
  return `${Math.round(ms * 3.6)} km/h`;
}

function fmtBearing(deg) {
  if (deg == null) return "–";
  const dirs = ["N","NE","E","SE","S","SW","W","NW"];
  return dirs[Math.round(deg / 45) % 8] + ` ${Math.round(deg)}°`;
}

// ── Custom vehicle marker SVG ───────────────────────────────────────────────
function makeVehicleIcon(color, bearing, label) {
  const size = 28;
  const r = bearing != null ? bearing : 0;
  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 28 28">
      <defs>
        <filter id="glow">
          <feGaussianBlur stdDeviation="1.5" result="blur"/>
          <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <g transform="rotate(${r},14,14)" filter="url(#glow)">
        <circle cx="14" cy="14" r="9" fill="${color}" opacity="0.9"/>
        <polygon points="14,3 17,11 14,8 11,11" fill="${color}"/>
      </g>
      <text x="14" y="18" text-anchor="middle" font-size="7" font-weight="bold"
            font-family="JetBrains Mono,monospace" fill="#080c10">${label || ""}</text>
    </svg>`;
  return L.divIcon({
    html: svg,
    className: "",
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2],
  });
}

// ── Map init ─────────────────────────────────────────────────────────────────
const map = L.map("map", {
  center: [51.0, 4.3],  // Belgium centre
  zoom: 9,
  zoomControl: true,
  attributionControl: true,
});

L.tileLayer(TILE_URL, {
  attribution: TILE_ATTR,
  subdomains: "abcd",
  maxZoom: 19,
}).addTo(map);

// ── State ───────────────────────────────────────────────────────────────────
const markers = {};      // vehicleId → L.Marker
const vehicleData = {};  // vehicleId → enriched object
let delayLookup = {};    // tripId → delay in seconds (from TripUpdates)
let activeVehicleId = null;
let refreshTimer = null;
let progressTimer = null;
let progressStart = null;

// ── Toast ───────────────────────────────────────────────────────────────────
let toastTimer = null;
function showToast(msg, isError = false) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.className = "show" + (isError ? " error" : "");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = ""; }, 3500);
}

// ── Progress bar ─────────────────────────────────────────────────────────────
function startProgress() {
  clearInterval(progressTimer);
  progressStart = Date.now();
  const bar = document.getElementById("refresh-progress");
  progressTimer = setInterval(() => {
    const pct = Math.min(100, ((Date.now() - progressStart) / REFRESH_INTERVAL) * 100);
    bar.style.width = pct + "%";
    if (pct >= 100) clearInterval(progressTimer);
  }, 250);
}

// ── Fetch & render ───────────────────────────────────────────────────────────
async function fetchAndRender() {
  const pulseDot = document.getElementById("pulse-dot");
  const liveText = document.getElementById("live-text");
  pulseDot.className = "pulse loading";
  liveText.textContent = "Fetching…";

  let data;
  try {
    const resp = await fetch("/api/gtfs", { cache: "no-store" });
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({ error: `HTTP ${resp.status}` }));
      throw new Error(err.error || `HTTP ${resp.status}`);
    }
    data = await resp.json();
  } catch (err) {
    pulseDot.className = "pulse error";
    liveText.textContent = "Error";
    showToast("⚠ " + err.message, true);
    return;
  }

  pulseDot.className = "pulse";
  liveText.textContent = "Live";
  document.getElementById("last-update").textContent =
    new Date().toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", second: "2-digit" });

  processEntities(data.entity || []);
  startProgress();
}

function processEntities(entities) {
  // ── Build delay lookup from TripUpdates ───────────────────────────────
  delayLookup = {};
  let tripCount = 0;
  for (const e of entities) {
    const tu = e.tripUpdate;
    if (!tu) continue;
    tripCount++;
    const tripId = tu.trip?.tripId;
    if (!tripId) continue;
    const updates = tu.stopTimeUpdate || [];
    if (updates.length > 0) {
      const last = updates[updates.length - 1];
      const delay = last.departure?.delay ?? last.arrival?.delay ?? 0;
      delayLookup[tripId] = delay;
    }
  }

  // ── Process VehiclePositions ─────────────────────────────────────────
  const seen = new Set();
  let vehicleCount = 0;
  let onTime = 0;
  let delayed = 0;

  for (const e of entities) {
    const vp = e.vehicle;
    if (!vp?.position) continue;

    const lat = vp.position.latitude;
    const lng = vp.position.longitude;
    if (!lat || !lng) continue;

    vehicleCount++;
    const vehicleId = vp.vehicle?.id || e.id || `v${vehicleCount}`;
    const tripId = vp.trip?.tripId || "";
    const routeId = vp.trip?.routeId || parseRoute(tripId);
    const label = vp.vehicle?.label || parseRoute(tripId);
    const bearing = vp.position.bearing;
    const speed = vp.position.speed;
    const delay = delayLookup[tripId] ?? null;

    if (delay != null && Math.abs(delay) < 60) onTime++;
    else if (delay != null && delay >= 60) delayed++;

    const color = routeColor(routeId || tripId);
    seen.add(vehicleId);

    const info = { vehicleId, tripId, routeId, label, lat, lng, bearing, speed, delay, color };
    vehicleData[vehicleId] = info;

    // ── Update or create marker ───────────────────────────────────────
    const icon = makeVehicleIcon(color, bearing, parseRoute(tripId));
    if (markers[vehicleId]) {
      markers[vehicleId].setLatLng([lat, lng]);
      markers[vehicleId].setIcon(icon);
    } else {
      const marker = L.marker([lat, lng], { icon })
        .addTo(map)
        .on("click", () => selectVehicle(vehicleId));
      markers[vehicleId] = marker;
    }
  }

  // ── Remove stale markers ─────────────────────────────────────────────
  for (const id of Object.keys(markers)) {
    if (!seen.has(id)) {
      map.removeLayer(markers[id]);
      delete markers[id];
      delete vehicleData[id];
    }
  }

  // ── Update stats ─────────────────────────────────────────────────────
  document.getElementById("stat-vehicles").textContent = vehicleCount;
  document.getElementById("stat-trips").textContent = tripCount;
  document.getElementById("stat-ontime").textContent = onTime;
  document.getElementById("stat-delayed").textContent = delayed;

  renderList();
}

// ── Sidebar vehicle list ─────────────────────────────────────────────────────
function renderList() {
  const container = document.getElementById("vehicle-list");
  const sorted = Object.values(vehicleData).sort((a, b) =>
    (b.delay || 0) - (a.delay || 0)
  );

  document.getElementById("filter-badge").textContent = sorted.length;

  container.innerHTML = "";
  for (const v of sorted) {
    const delayTxt = fmtDelay(v.delay);
    const isDelayed = v.delay != null && v.delay >= 60;
    const isEarly = v.delay != null && v.delay < -30;

    const item = document.createElement("div");
    item.className = "vehicle-item" + (v.vehicleId === activeVehicleId ? " active" : "");
    item.dataset.id = v.vehicleId;
    item.innerHTML = `
      <div class="v-badge" style="background:${v.color}22;color:${v.color};border:1px solid ${v.color}44;">
        ${parseRoute(v.tripId)}
      </div>
      <div class="v-info">
        <div class="v-route">${v.label || v.vehicleId}</div>
        <div class="v-meta">${v.vehicleId}</div>
      </div>
      <div class="v-delay" style="color:${isDelayed ? 'var(--danger)' : isEarly ? 'var(--accent3)' : 'var(--text-dim)'}">
        ${delayTxt}
      </div>`;
    item.addEventListener("click", () => selectVehicle(v.vehicleId));
    container.appendChild(item);
  }
}

// ── Select / focus a vehicle ─────────────────────────────────────────────────
function selectVehicle(id) {
  activeVehicleId = id;
  const v = vehicleData[id];
  if (!v) return;

  // Pan map
  map.setView([v.lat, v.lng], Math.max(map.getZoom(), 13), { animate: true });

  // Open popup
  const delay = fmtDelay(v.delay);
  const delayColor = v.delay != null && v.delay >= 60 ? "var(--danger)"
    : v.delay != null && v.delay < -30 ? "var(--accent3)"
    : "var(--text-dim)";

  markers[id]?.bindPopup(`
    <div class="popup-inner">
      <div class="popup-route" style="color:${v.color}">${parseRoute(v.tripId)}</div>
      <div class="popup-trip">${v.tripId || "–"}</div>
      <div class="popup-grid">
        <div>
          <div class="popup-field-label">Vehicle</div>
          <div class="popup-field-value">${v.vehicleId}</div>
        </div>
        <div>
          <div class="popup-field-label">Delay</div>
          <div class="popup-field-value" style="color:${delayColor}">${delay}</div>
        </div>
        <div>
          <div class="popup-field-label">Speed</div>
          <div class="popup-field-value">${fmtSpeed(v.speed)}</div>
        </div>
        <div>
          <div class="popup-field-label">Bearing</div>
          <div class="popup-field-value">${fmtBearing(v.bearing)}</div>
        </div>
        <div>
          <div class="popup-field-label">Lat</div>
          <div class="popup-field-value">${v.lat.toFixed(5)}</div>
        </div>
        <div>
          <div class="popup-field-label">Lng</div>
          <div class="popup-field-value">${v.lng.toFixed(5)}</div>
        </div>
      </div>
    </div>`, { maxWidth: 260 }
  ).openPopup();

  // Highlight list item
  document.querySelectorAll(".vehicle-item").forEach(el => {
    el.classList.toggle("active", el.dataset.id === id);
  });
}

// ── Auto-refresh ─────────────────────────────────────────────────────────────
function scheduleRefresh() {
  clearTimeout(refreshTimer);
  refreshTimer = setTimeout(async () => {
    await fetchAndRender();
    scheduleRefresh();
  }, REFRESH_INTERVAL);
}

// ── Boot ─────────────────────────────────────────────────────────────────────
(async () => {
  await fetchAndRender();
  scheduleRefresh();
})();
</script>
</body>
</html>
